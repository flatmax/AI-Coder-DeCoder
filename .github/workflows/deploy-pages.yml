name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages or initialize
        run: |
          # Try to clone gh-pages branch, or create empty directory if it doesn't exist
          git clone --depth 1 --branch gh-pages "https://github.com/${{ github.repository }}.git" gh-pages 2>/dev/null || {
            echo "gh-pages branch doesn't exist, creating fresh directory"
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: source

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Build webapp
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"  # Extract repo name from owner/repo
          npm run build -- --base=/${REPO_NAME}/${{ steps.sha.outputs.short }}/
        working-directory: source

      - name: Deploy versioned build
        run: |
          SHORT_SHA="${{ steps.sha.outputs.short }}"
          DEPLOY_DIR="gh-pages/${SHORT_SHA}"
          
          # Remove existing version if present (re-run case)
          rm -rf "${DEPLOY_DIR}"
          
          # Copy new build (has base=/{sha}/)
          cp -r source/webapp/dist/ "${DEPLOY_DIR}"

      - name: Update versions.json
        run: |
          SHORT_SHA="${{ steps.sha.outputs.short }}"
          FULL_SHA="${{ github.sha }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VERSIONS_FILE="gh-pages/versions.json"
          
          # Create or update versions.json
          if [ -f "${VERSIONS_FILE}" ]; then
            # Add new version to the front, update latest
            jq --arg sha "$SHORT_SHA" \
               --arg full "$FULL_SHA" \
               --arg date "$DATE" \
               --arg branch "${{ github.ref_name }}" \
               '.latest = $sha | .versions = [{"sha": $sha, "full_sha": $full, "date": $date, "branch": $branch}] + .versions' \
               "${VERSIONS_FILE}" > tmp.json && mv tmp.json "${VERSIONS_FILE}"
          else
            # Create new versions.json
            cat > "${VERSIONS_FILE}" << EOF
          {
            "latest": "${SHORT_SHA}",
            "versions": [
              {"sha": "${SHORT_SHA}", "full_sha": "${FULL_SHA}", "date": "${DATE}", "branch": "${{ github.ref_name }}"}
            ]
          }
          EOF
          fi

      - name: Cleanup old versions (keep last 20)
        run: |
          VERSIONS_FILE="gh-pages/versions.json"
          
          if [ -f "${VERSIONS_FILE}" ]; then
            # Get list of SHAs to keep (latest 20)
            KEEP_SHAS=$(jq -r '.versions[:20][].sha' "${VERSIONS_FILE}")
            
            # Trim versions array to 20 entries
            jq '.versions = .versions[:20]' "${VERSIONS_FILE}" > tmp.json && mv tmp.json "${VERSIONS_FILE}"
            
            # Remove old version directories
            for dir in gh-pages/*/; do
              dirname=$(basename "$dir")
              # Check if this SHA should be kept
              if ! echo "$KEEP_SHAS" | grep -q "^${dirname}$"; then
                echo "Removing old version: ${dirname}"
                rm -rf "$dir"
              fi
            done
          fi

      - name: Create root index.html
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"
          cat > gh-pages/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AC-DC Webapp</title>
            <style>
              body {
                font-family: system-ui, -apple-system, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: #1a1a2e;
                color: #eee;
              }
              a { color: #4dabf7; }
              .error { color: #ff6b6b; }
            </style>
          </head>
          <body>
            <p id="status">Loading version info...</p>
            <script>
              const repoName = '${REPO_NAME}';
              fetch('/' + repoName + '/versions.json')
                .then(r => r.json())
                .then(data => {
                  if (data.latest) {
                    const query = window.location.search;
                    window.location.href = '/' + repoName + '/' + data.latest + '/' + query;
                  } else {
                    document.getElementById('status').innerHTML =
                      '<span class="error">No versions available</span>';
                  }
                })
                .catch(err => {
                  document.getElementById('status').innerHTML =
                    '<span class="error">Failed to load versions: ' + err.message + '</span>';
                });
            </script>
          </body>
          </html>
          EOF

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update remote URL with authentication token
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" 2>/dev/null || \
            git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          
          git add -A
          git commit -m "Deploy ${{ steps.sha.outputs.short }} from ${{ github.ref_name }}" || echo "No changes to commit"
          
          # Push (create branch if doesn't exist)
          git push origin gh-pages --force || git push --set-upstream origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4